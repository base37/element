<style></style>
<template>
    <slot></slot>
</template>
<script>
    class extends `` {

        #source = 'eContext'
        #root = '.'
        #base = './'
        #transform
        #pathto = ['a', 'href']

        constructor() {
            super()
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('source', 'root', 'base', 'transform', 'pathto') }

        async connectedCallback() {
            super.connectedCallback()
        }

        async readyCallback() {
            await super.readyCallback()
            const source = this.e.applyField(this.#root, this[this.#source] ?? {})
            console.log(JSON.stringify(source, null, 4))
            const newChildren = []
            for (const name in source) {
                const templateNode = this.querySelector(`[slot="${name}"]`) || this.querySelector(`[slot="*"]`)
                if (templateNode) {
                    const useData = name === '@' ? source[name] : (source[name]['@'] ?? {})
                    const newChild = templateNode.cloneNode(true)
                    if (this.#pathto.length && newChild.matches(this.#pathto[0])) newChild.setAttribute(this.#pathto[1], `${this.#base||''}${name==='@'?'':name}`)
                    this.e.sinkData(newChild, useData, 'auto', this.#transform)
                    newChild.removeAttribute('slot')
                    if (name === '@') {
                        newChildren.push(newChild)
                        continue
                    }

                    const childTemplateNodes = []
                    const infiniteTemplateNode = this.querySelector(`[slot="***"]`)
                    if (infiniteTemplateNode) childTemplateNodes.push(infiniteTemplateNode.cloneNode(true))
                    for (const node of this.querySelectorAll(`[slot^="*.*"]`)) {
                        const childTemplateNode = node.cloneNode(true)
                        childTemplateNode.setAttribute('slot', childTemplateNode.getAttribute('slot').replace('*.', ''))
                        childTemplateNodes.push(childTemplateNode)
                    }
                    for (const node of this.querySelectorAll(`[slot^="${name}."]`)) {
                        const childTemplateNode = node.cloneNode(true)
                        childTemplateNode.setAttribute('slot', childTemplateNode.getAttribute('slot').replace(`${name}.`, ''))
                        childTemplateNodes.push(childTemplateNode)
                    }
                    if (childTemplateNodes.length) {
                        const childTree = document.createElement('e-tree')
                        this.#source && childTree.setAttribute('source', this.#source)
                        childTree.setAttribute('base', `${this.#base||''}${name}/`)
                        this.#transform && childTree.setAttribute('transform', this.#transform)
                        this.#pathto && childTree.setAttribute('pathto', this.#pathto)
                        childTree.replaceChildren(...childTemplateNodes)
                        newChildren.push(childTree)
                    } else { newChildren.push(newChild) }
                } 
            }
            this.replaceChildren(...newChildren)
        }

        set source(value) { this.#source = value }
        get source() { return this.#source }

        set root(value) { this.#root = value }
        get root() { return this.#root }

        set base(value) { this.#base = value }
        get base() { return this.#base }

        set transform(value) { this.#transform = value }
        get transform() { return this.#transform }

        set pathto(value) { this.#pathto = value ? value.split(':').map(s => s.trim()) : [] }
        get pathto() { return this.#pathto.join(':') }

    }
</script>
