<style></style>
<template><slot></slot></template>
<script>
    class extends `./abstract/routable` {

    	constructor() {
    		super()
            Object.defineProperties(this, {
                _mode: {configurable: false, enumerable: false, writable: false, value: 'theme'}, 
                _parse: {configurable: false, enumerable: false, writable: false, value: async (response) => { 
                    let text = await response.text()
                    if (response.status >= 400) {
                        this.dispatchEvent(new CustomEvent('error', {detail: {type: 'fetch', status: response.status, message: text}}))
                        if (this.errors === 'throw') { throw new Error(text); return } else if (this.errors === 'hide') { text = '' }
                    }
                    return await (new CSSStyleSheet()).replace(text) 
                }},
                _as: {configurable: false, enumerable: false, writable: false, value: async (useResponse, addOrRemove, node, previousSibling, nextSibling, oldAttributeValues) => {
                    if (addOrRemove === 'add') {
                        const styleNode = document.createElement('style')
                        this.dataset.stylesheetId = crypto.randomUUID()
                        styleNode.setAttribute('id', this.dataset.stylesheetId)
                        styleNode.textContent = Array.from(useResponse.cssRules).map(r => r.cssText).join('\n')
                        if ((node.parentElement === document.head) || [document, document.head, document.body].includes(node)) {
                            this.as === 'underlay' ? document.head.prepend(styleNode) : document.head.append(styleNode)
                        } else if (node instanceof ShadowRoot || node.shadowRoot instanceof ShadowRoot) {
                            const shadow = node instanceof ShadowRoot ? node : node.shadowRoot
                            this.as === 'underlay' ? shadow.prepend(styleNode) : shadow.querySelector('style:last-of-type')?.after(styleNode)                            
                        }
                        this.addEventListener('change', event => {
                            if (['router', 'pointer'].includes(event.detail.attributeName)) {
                                document.getElementById(this.dataset.stylesheetId)?.remove()
                                this._useResponse.then(r => this._as(r, 'add', node, previousSibling, nextSibling, {}))
                            }
                        })
                    }
                }}
            })
    	}

		static get observedAttributes() { return (super.observedAttributes || []).concat() }

    }
</script>