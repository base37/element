<style></style>
<template><slot></slot></template>
<script>
    class extends `./abstract/routable` {

        #parser
        #data

        constructor() {
            super()
            Object.defineProperties(this, {
                _mode: {configurable: false, enumerable: false, writable: false, value: 'data'}, 
                _parse: {configurable: false, enumerable: false, writable: false, value: async (response) => {
                    let parsed = await response.text()
                    if (response.status >= 400) this.dispatchEvent(new CustomEvent('error', {detail: {type: 'load', status: response.status, message: parsed}}))
                    if (this.#parser) {
                        let parserFunction = this.e.resolveMeta(this, 'e-processor', this.#parser)?.func
                        if (parserFunction) parsed = await parserFunction(parsed)
                    } else { try { parsed = JSON.parse(parsed) } catch(e) { parsed = {} } }
                    return parsed
                }},
                _applyHash: {configurable: false, enumerable: false, writable: false, value: async (parsedResponse) => {
                    return this.e.applyHash(this._hash, await this._routable._applyHash(parsedResponse))
                }}, 
                _applyField: {configurable: false, enumerable: false, writable: false, value: async (parsedResponse) => {
                    return this.e.applyField(this._field, await this._routable._applyField(parsedResponse))
                }},                
                _as: {configurable: false, enumerable: false, writable: false, value: async (useResponse, addOrRemove, node, previousSibling, nextSibling, oldAttributeValues) => {
                    if (addOrRemove === 'add' && (useResponse instanceof Object)) {
                        this.#data = useResponse
                        this.e.sinkData(node, this.#data, ...this.e.utils.splitOnce((this.as || ''), ';'))
                    }
                }}
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('parser') }

        set parser(value) { this.#parser = value }
        get parser() { return this.#parser }

        get data() { return this.#data || {} }

    }
</script>
