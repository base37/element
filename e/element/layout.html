<style></style>
<template><slot></slot></template>
<script>
    class extends `./abstract/routable` {

    	constructor() {
    		super()
            Object.defineProperties(this, {
                _mode: {configurable: false, enumerable: false, writable: false, value: 'layout'}, 
                _parse: {configurable: false, enumerable: false, writable: false, value: async (response) => {
                    let text = await response.text(), template = document.createElement('template')
                    if (response.status >= 400) this.dispatchEvent(new CustomEvent('error', {detail: {type: 'load', status: response.status, message: text}}))
                    template.innerHTML = text
                    return template.content.cloneNode(true).children
                }},
                _applyHash: {configurable: false, enumerable: false, writable: false, value: async (parsedResponse) => {
                    return this.e.applyHash(this._hash, await this._routable._applyHash(parsedResponse))
                }}, 
                _as: {configurable: false, enumerable: false, writable: false, value: async (useResponse, addOrRemove, node, previousSibling, nextSibling, oldAttributeValues) => {
                    if (addOrRemove !== 'add') return 
                    const responseNodes = Array.from(useResponse).map(n => n.cloneNode(true))
                    const [useFromLayoutSelector, insertIntoLayoutAtSelector, usefromTargetSelector, postProcessor] = (this.as||'').split(';', 4).map(s => s.trim()), template = document.createElement('template')
                    template.content.replaceChildren(...responseNodes)
                    const documentFragment = template.content.cloneNode(true), 
                        replaceWithElements = useFromLayoutSelector ? documentFragment.querySelectorAll(useFromLayoutSelector) : documentFragment.children
                    if (insertIntoLayoutAtSelector) {
                        const insertContent = usefromTargetSelector === ':scope' ? node.childNodes 
                            : (usefromTargetSelector 
                                ? node.cloneNode(true).querySelectorAll(usefromTargetSelector) : [node.cloneNode(true)]) 
                        for (const r of replaceWithElements) {
                            const replaceAt = insertIntoLayoutAtSelector === ':scope' ? [r] : r.querySelectorAll(insertIntoLayoutAtSelector)
                            for (const rs of replaceAt) rs.replaceChildren(...insertContent)
                        }
                    }
                    if (!this.hasAttribute('scope') && !this.hasAttribute('observe') && !this.hasAttribute('match')) {
                        this.replaceWith(...replaceWithElements)
                    } else {
                        node.replaceWith(...replaceWithElements)                    
                    }
                    if (postProcessor) {
                        const postProcessFunction = this.e.resolveMeta(this, 'e-processor', postProcessor)?.func
                        if (typeof postProcessFunction === 'function') postProcessFunction(replaceWithElements)
                    }
                }}
            })
    	}

		static get observedAttributes() { return (super.observedAttributes || []).concat() }

    }
</script>