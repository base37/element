<style></style>
<template><slot></slot></template>
<script>
    class extends `./abstract/routable` {

        #canonicalUrl
        #validate = input => true

        constructor() {
            super()
            Object.defineProperties(this, {
                _mode: {configurable: false, enumerable: false, writable: false, value: 'processor'}, 
                _parse: {configurable: false, enumerable: false, writable: false, value: async (response) => {
                    let schemaText = await response.text()
                    if (response.status >= 400) this.dispatchEvent(new CustomEvent('error', {detail: {type: 'load', status: response.status, message: schemaText}}))
                    if (!this.e.env.libraries.ajv) {
                        this.e.env.libraries.ajv = new (await import('https://cdn.jsdelivr.net/npm/ajv@8.12.0/+esm')).default({allErrors: true, verbose: true})
                        const addFormats = (await import('https://cdn.jsdelivr.net/npm/ajv-formats/+esm')).default
                        addFormats(this.e.env.libraries.ajv)
                    } 
                    const canonicalUrl = this.e.getURL(response)
                    let validate = this.e.env.libraries.ajv.getSchema(canonicalUrl)
                    if (!validate) {
                        let schemaFetch = await fetch(canonicalUrl), schemaText = await schemaFetch.text()
                        if (schemaFetch.status >= 400) this.dispatchEvent(new CustomEvent('error', {detail: {type: 'load', status: schemaFetch.status, message: schemaText}}))
                        this.e.env.libraries.ajv.addSchema(schemaText, canonicalUrl)
                        validate = this.e.env.libraries.ajv.getSchema(canonicalUrl)
                    }
                    return [canonicalUrl, typeof validate === 'function' ? validate : null]
                }},
                _as: {configurable: false, enumerable: false, writable: false, value: async (useResponse, addOrRemove, node, previousSibling, nextSibling, oldAttributeValues) => {
                    let [ canonicalUrl, validate ] = useResponse
                    if (canonicalUrl) this.#canonicalUrl = canonicalUrl
                    if (validate) this.#validate = validate
                    if (addOrRemove === 'add') {
                        node.eSchema = this.#canonicalUrl
                        const abortController = new AbortController(), signal = abortController.signal
                        node.addEventListener('change', event => {
                            const valid = this.#validate(this.e.getValue(node)), errors = valid ? [] : [...this.#validate.errors]
                            if (!valid) node.dispatchEvent(new CustomEvent('error', {detail: errors}))
                        }, { signal })
                        if (!this._selfObserver) {
                            this._selfObserver = new MutationObserver(event => {
                                if (event[0] && event[0].attributeName == 'use') {
                                    abortController.abort()
                                    this._useResponse.then(r => this._as(r, 'add', node, previousSibling, nextSibling, {}))
                                }
                            })
                            this._selfObserver.observe(this, { attributes: true })
                        }
                    }
                }}
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('parser') }

        get validate(data) { 
            const valid = this.#validate(data), errors = valid ? [] : [...this.#validate.errors]
            return [valid, errors]
        }

        get canonicalUrl() { return this.#canonicalUrl }

    }
</script>