<style></style>
<template><slot></slot></template>
<script>
    class extends `./abstract/routable` {

        #validate = input => true

        constructor() {
            super()
            Object.defineProperties(this, {
                _mode: {configurable: false, enumerable: false, writable: false, value: 'processor'}, 
                _parse: {configurable: false, enumerable: false, writable: false, value: async (response) => {
                    let schemaText = await response.text()
                    if (response.status >= 400) this.dispatchEvent(new CustomEvent('error', {detail: {type: 'load', status: response.status, message: schemaText}}))
                    if (!this.e.env.libraries.ajv) {
                        this.e.env.libraries.ajv = new (await import('https://cdn.jsdelivr.net/npm/ajv@8.12.0/+esm')).default({allErrors: true, verbose: true})
                        const addFormats = (await import('https://cdn.jsdelivr.net/npm/ajv-formats/+esm')).default
                        addFormats(this.e.env.libraries.ajv)
                    } 
                    const canonicalUri = this.e.getURL(response)
                    let validate = this.e.env.libraries.ajv.getSchema(canonicalUri)
                    if (!validate) {
                        let schemaFetch = await fetch(canonicalUri), schemaText = await schemaFetch.text()
                        if (schemaFetch.status >= 400) this.dispatchEvent(new CustomEvent('error', {detail: {type: 'load', status: schemaFetch.status, message: schemaText}}))
                        this.e.env.libraries.ajv.addSchema(schemaText, canonicalUri)
                        validate = this.e.env.libraries.ajv.getSchema(canonicalUri)
                    }
                    return typeof validate === 'function' ? validate : undefined
                }},
                _as: {configurable: false, enumerable: false, writable: false, value: async (useResponse, addOrRemove, node, previousSibling, nextSibling, oldAttributeValues) => {
                    if (validate) this.#validate = validate
                    if (addOrRemove === 'add') {
                        node.addEventListener('change', event => {
                            const valid = this.#validate(this.e.getValue(node)), errors = valid ? [] : [...this.#validate.errors]
                            if (!valid) node.dispatchEvent(new CustomEvent('error', {detail: errors}))
                        })
                    }
                }}
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('parser') }

        get validate() { return this.#validate }        

    }
</script>