<style></style>
<template></template>
<script>
    export default class extends `./pointer` {

        #transition
        #transitionScope
        #transitionString

        constructor() {
            super()
            Object.defineProperties(this, {
                _apply: {
                    configurable: false, enumerable: false, value: async (result, target) => {
                        if (typeof result !== 'string') {
                            if (!Array.isArray(result)) result = [result]
                            for (const [i, r] of result.entries()) if (r instanceof Node) result[i] = r.textContent
                            result = result.join('')
                        }
                        const validContentScopes = ['innerHTML', 'innerText', 'textContent', 'value']
                        let apply = this.apply ?? this.getAttribute('apply') ?? 'innerHTML'
                        if (!validContentScopes.includes(apply)) apply = 'innerHTML'
                        for (const t of target) {
                            if (!t) continue
                            if (apply.startsWith('@')) {
                                const attrName = apply.slice(1)
                                if (t.getAttribute(attrName) == result) return
                                t.setAttribute(attrName, result)
                            } else {
                                if (t[apply] == result) return
                                if (!document.startViewTransition || !this.#transition || apply === 'value') { t[apply] = result; continue }
                                const transition = document.startViewTransition(() => { t[apply] = result })
                                transition.ready.then(() => {
                                    this.dispatchEvent(new CustomEvent('transition-ready'))
                                    let scope = this.#transitionScope ? t.closest(this.#transitionScope) : t.getRootNode()
                                    scope.animate(this.#transition)
                                })
                                transition.finished.then(() => {
                                    this.dispatchEvent(new CustomEvent('transition-finished'))
                                })
                                transition.updateCallbackDone.then(() => {
                                    this.dispatchEvent(new CustomEvent('transition-updateCallbackDone'))
                                })
                            }
                        }
                    }
                },
                _mode: { configurable: false, enumerable: false, writable: false, value: 'content' }
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('transition', 'transition-scope') }

        get transition() { return this.#transitionString }
        set transition(value) {
            this.#transition = this.E.utils.parseObjectAttribute(value, this)
            this.#transitionString = value
        }

        get transitionScope() { return this.#transitionScope }
        set transitionScope(value) { this.#transitionScope = value }

        get ['transition-scope']() { return this.transitionScope }
        set ['transition-scope'](value) { this.transitionScope = value }

    }
</script>