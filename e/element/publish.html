<style>
    dialog.e-publish {
        min-width: 600px;
        font-family: sans-serif;
        font-size: 17px;
        max-height: 800px;

    }
    dialog.e-publish legend {
        font-size: large;
        font-weight: bold;
        text-transform: capitalize;
    }
    dialog.e-publish fieldset label, dialog.e-publish label small, dialog.e-publish label input {
        display: block;
        width: 100%;
    }
    dialog.e-publish fieldset {
        margin-top: 37px;
        margin-bottom: 37px;
    }
    dialog.e-publish fieldset label {
        margin-top: 17px;
        margin-bottom: 17px;
        font-size: 19px;
    }
    dialog.e-publish fieldset label input {
        display: inline-block;
        width: calc(100% - 8px);
    }
    dialog.e-publish fieldset label small {
        font-weight: bold;
        font-size: 15px;
        text-transform: capitalize;
    }


</style>
<template>
    <form method="dialog">
        <legend>Publish Configuration</legend>
        <menu>
            <meta is="e-data" resource="|button[value='cancel']|!" target="dialog|" apply="close">
            <button value="cancel">Cancel</button>
            <button type="submit" value="publish">Publish</button>
        </menu>        
    </form>
</template>
<script>
    class extends `./pointer` {

        #manifest
        #abortController = new AbortController()
        #dialogId
        #dialog

        #manifestDefaults = {
            "$": {
                "credentials": {}, 
                "variables": {},  
                "page-defaults": {}, 
                "replace": {}, 
                "sinkData": {
                    "meta[is^='e-'][resource$=':#']": "{\"@resource\": $replace($.`@resource`, \":#\", \":/\")}", 
                    "meta[is^='e-'][resource$=':?']": "{\"@resource\": $replace($.`@resource`, \":?\", \":/\")}"
                }, 
                "trigger": { "altKey": false, "ctrlKey": false, "metaKey": true, "shiftKey": true, "key": "P" }
            }, 
            "pages": {}          
        }

        constructor() {
            super()
            Object.defineProperties(this, {
                _mode: {configurable: false, enumerable: false, writable: false, value: 'publish'},
                _apply: {configurable: false, enumerable: false, value: async (result, target) => {
                    if (result instanceof Object) {
                        result.$ = result.$ instanceof Object ? {...this.#manifestDefaults.$, ...result.$} : this.#manifestDefaults.$
                        result.pages = result.pages instanceof Object ? {...this.#manifestDefaults.pages, ...result.pages} : this.#manifestDefaults.pages
                        for (const ent of Object.entries(this.#manifestDefaults.$)) {
                            result.$[ent[0]] = result.$[ent[0]] instanceof Object 
                                ? {...this.#manifestDefaults.$[ent[0]], ...result.$[ent[0]]} : this.#manifestDefaults.$[ent[0]]
                        }
                    }
                    this.#manifest = result
                    if (!this.#manifest) return
                    document.addEventListener('keydown', event => {
                        const validTrigger = Object.entries(this.#manifest.$?.trigger || {}).every(ent =>  event[ent[0]] == ent[1])
                        if (validTrigger) {
                            event.preventDefault()
                            this.publish()
                        } 
                    })

                    this.#dialogId = crypto.randomUUID()
                    this.#dialog = document.createElement('dialog')
                    this.#dialog.setAttribute('id', this.#dialogId)
                    this.#dialog.classList.add('e-publish')
                    this.#dialog.innerHTML = `<style>${this.e.styles[this.constructor.id]}</style>${this.e.templates[this.constructor.id]}`
                    const dialogMenu = this.#dialog.querySelector('menu')
                    for (const fieldsetName of Object.keys(this.#manifest.$)) {
                        if (!(this.#manifest.$[fieldsetName] instanceof Object)) continue
                        const fieldEntries = Object.entries(this.#manifest.$[fieldsetName]).filter(ent => ent[1] === null)
                        if (!fieldEntries.length) continue
                        const fieldset = document.createElement('fieldset')
                        fieldset.setAttribute('name', fieldsetName)                        
                        const fieldInputs = fieldEntries.map(ent => `<label><small>${ent[0]}</small><input type="text" name="${ent[0]}"></label>`).join('')
                        fieldset.innerHTML = `<legend>${fieldsetName.replaceAll('-', ' ')}</legend>${fieldInputs}`
                        dialogMenu.before(fieldset)
                        const getStored = fieldsetName => {
                            let storedFieldset = window.sessionStorage.getItem(`publish:${fieldsetName}`)
                            if (storedFieldset) {
                                try { storedFieldset = JSON.parse(storedFieldset) } catch(e) { storedFieldset = null }
                                if (!(storedFieldset instanceof Object)) storedFieldset = null
                            }
                            return storedFieldset
                        }
                        for (const fieldInput of fieldset.querySelectorAll('input')) {
                            const fieldInputName = fieldInput.getAttribute('name'), storedRead = getStored(fieldsetName) ?? {}
                            if (storedRead[fieldInputName]) fieldInput.value = storedRead[fieldInputName]
                            fieldInput.addEventListener('change', event => {
                                const storedWrite = getStored(fieldsetName) ?? {}
                                storedWrite[fieldInputName] = fieldInput.value
                                window.sessionStorage.setItem(`publish:${fieldsetName}`, JSON.stringify(storedWrite))
                            })
                        }
                    }


                    document.body.append(this.#dialog)


                    /* 
{
    "$": {
        "trigger": {
            "altKey": false, 
            "ctrlKey": false, 
            "metaKey": true, 
            "shiftKey": true, 
            "key": "p"
        }, 
        "credentials": {
            ... set a value to null to prompt each time
        }, 
        "variables": {
            "marker": "value", ... set value null if you want to prompt each time 
        },  
        "page-defaults": {
            ... this object will be used as the base over which each page object will be applied before processing
        }, 
        "replace": { ... keys are selectors, values are HTML which will be used to replace the matched elements ... }, 
        "sinkData": {
            ... keys are selectors, values are objects which will be used as data to sink into the matched elements ...
        }
    }, 
    "pages": {
        "path-to-page": {
            title: "", meta: {
                "[content]": [... array of meta names to assign this content string to...]
            }
        }
    }
}
                    */
                    }
                }
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat() }

        async publish() {
            if (!this.#manifest) return
            this.#dialog.showModal()


        }

    }
</script>
