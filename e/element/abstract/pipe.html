<style></style>
<template></template>
<script>
    class extends `meta` {

        #resource
        #boundResource

        constructor() {
            super()
            Object.defineProperties(this, {
                _class: {configurable: true, enumerable: false, value: 'EventTarget'}, 
                _receiveEventName: {configurable: true, enumerable: false, value: 'receive'}, 
                _dataEventPayloadProperty: {configurable: true, enumerable: false, value: 'data'}, 
                _sendMethodName: {configurable: true, enumerable: false, value: 'send'}
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('resource', 'options') }

        async connectedCallback() {}

        async _new(value) {
            if (typeof window[this._class] === 'function') return new window[this._class](value, this._options)
        }
        async _send(payload) {
            if (this.#boundResource && (typeof this.#boundResource[this._sendMethodName] === 'function')) await this.#boundResource[this._sendMethodName](payload)
        }

        async set resource(value) {
            if (value) { 
                this.#boundResource = await this._new(value)
                this.#boundResource.addEventListener(this._receiveEventName, event => {
                    this.dispatchEvent(new CustomEvent('receive', {detail: event}))
                    this.dispatchEvent(new CustomEvent('data', {detail: event[this._receiveEventPayloadProperty]}))
                })                
            } else { this.#boundResource = undefined }
            this.#resource = value
        }
        get resource() { return this.#resource }

        set _resource(value) { this.#boundResource = value }
        get _resource() { return this.#boundResource }

        set options(value) {
            this.#options = this.e.utils.parseObjectAttribute(value)
            this.#optionsString = value
        }
        get options() { return this.#optionsString }

        get _options() { 
            const optionsAttr = this.getAttribute('options')
            if (optionsAttr && (this.#optionsString !== optionsAttr)) this.options = optionsAttr
            return this.#options 
        }

    }
</script>

