<style></style>
<template></template>
<script>
    class extends `meta` {

        #base
        #name
        #processor
        #priority = 'auto'
        #cache = 'default'
        #fetchOptions = {}
        _modes = {}

        _defaultProcessor = function(router, mode, path=undefined, suffix=undefined, pointer=undefined, get=false) {
            path ||= router._modes[mode]?.path ?? mode
            pointer ||= router._modes[mode]?.pointer ?? mode
            suffix ||= router._modes[mode]?.suffix ?? ''
            const url = new URL(`${router.base && router.base.endsWith('*') ? ('./') : (router.name + '/')}${path}/${pointer}${suffix?'.'+suffix:''}`, router.base ? (new URL(router.base, router.baseURI).href) : router.baseURI).href
            return get ? fetch(router.e.getURL(url), Object.assign({priority: router.#priority, cache: router.#cache}, router.#fetchOptions)) : url
        }

        static {
            Object.defineProperty(this, '_modes', {value: this.e.env.modes})
        }

    	constructor() {
    		super()
            for (const mode in this.constructor._modes) {
                this._modes[mode] ||= {...this.constructor._modes[mode]}
                let requestedProcessor = this.e.utils.resolveMeta(this, 'e-processor', this.#processor)?.func, processor = typeof requestedProcessor === 'function' ? requestedProcessor : this._defaultProcessor, modeSignature = this.getAttribute(mode)
                if (modeSignature) {
                    let [path, pointer, ...suffix] = modeSignature.split('/').map(s => s.split('.')).flat()
                    suffix = suffix.join('.')
                    this._modes[mode].path = path
                    this._modes[mode].pointer = pointer
                    this._modes[mode].suffix = suffix
                }
                this._modes[mode].path ||= this.constructor._modes[mode].path
                this._modes[mode].pointer ||= this.constructor._modes[mode].pointer
                this._modes[mode].suffix ||= this.constructor._modes[mode].suffix
                const f = processor.bind(this.e, this, mode, this._modes[mode].path, this._modes[mode].suffix)
                f.toString = processor.bind(this.e, this, mode, this._modes[mode].path, this._modes[mode].suffix, false, this._modes[mode].pointer)
                Object.defineProperty(this, mode, {configurable: true, enumerable: true, get: () => f})
            } 
    	}

        toString() { return this.#name }

        connectedCallback() {}

		static get observedAttributes() { return (super.observedAttributes || []).concat('base', 'name', 'processor', 'fetch-options') }

        set base(value) { this.#base = value }
        get base() { return this.#base }

        set name(value) { if (value !== this.#name) this.#name = value }
        get name() { return this.#name }

        set processor(value) { this.#processor = value }
        get processor() { return this.#processor }

        set fetchOptions(value) { this.#fetchOptions = this.e.utils.parseObjectAttribute(value) }
        get fetchOptions() { return this.#fetchOptions }

        set ['fetch-options'](value) { this.fetchOptions = value }
        get ['fetch-options']() { return this.fetchOptions }

    }
</script>