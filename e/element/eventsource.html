<style></style>
<template></template>
<script>
    class extends `./abstract/pipe` {

    	constructor() {
    		super()
            Object.defineProperties(this, {
                _class: {configurable: true, enumerable: false, value: 'EventSource'}, 
                _receiveEventName: {configurable: true, enumerable: false, value: 'message'}, 
                _receiveEventPayloadProperty: {configurable: true, enumerable: false, value: 'data'},
                _sendMethodName: {configurable: true, enumerable: false, value: 'send'}
            })
    	}

		static get observedAttributes() { return (super.observedAttributes || []).concat() }

        async _new(value) {
            const url = this.e.getURL(value), options = this._options, 
                es = new EventSource(url, options.withCredentials ? {withCredentials: options.withCredentials} : {})
            if (options.events) {
                for (const eventName in options.events.split(',').map(s => s.trim())) {
                    es.addEventListener(eventName, event => {
                        this.dispatchEvent(new CustomEvent('receive', {detail: event}))
                        this.dispatchEvent(new CustomEvent(eventName, {detail: event[this._receiveEventPayloadProperty]}))
                    })
                }
            }
            return new Promise((resolve, reject) => { es.addEventListener('open', event => resolve(es)) }) 
        }

    }
</script>