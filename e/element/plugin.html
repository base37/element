<style></style>
<template></template>
<script>
    export default class extends `./pointer` {

        #abortController
        #map
        #mapMap
        #module

        constructor() {
            super()
            this.#abortController = new AbortController()
            Object.defineProperties(this, {
                _apply: {
                    configurable: false, enumerable: false, value: async (result, target) => {
                        this.#module = result
                        let applyMap = this.applyMap
                        if (applyMap) {
                            let applyEntries = Object.entries(this.applyMap ?? {})
                            for (const [role, mm] of applyEntries) {
                                if ((typeof this.#module[mm] === 'function') && role.startsWith('gateway:')) {
                                    const [, protocol] = role.split(':')
                                    if (protocol) this.e.env.gateways[protocol] = this.#module[mm]
                                } else if (role.startsWith('$')) {
                                    const variableName = role.slice(1)
                                    if (variableName) this.e.env.variables[variableName] = this.#module[mm]
                                } else { continue }
                                delete applyEntries[role]
                            }
                            this.#abortController.abort()
                            this.#abortController = new AbortController()
                            const setResult = (result, role, element, silent) => {
                                if (!role || !result || !element) return
                                const role1 = role.slice(1)
                                if (role === '_') {
                                    return this.e._(element, result, silent)
                                } else if (role[0] === '$') {
                                    if ((role === '$') || role.startsWith('$|')) {
                                        let [fl, tr] = this.e.utils.splitOnce(role1.slice(1), ',').map(s => s.trim())
                                        return this.e.$(element, result, fl, tr, this, silent)
                                    } else {
                                        if (!role1) return
                                        this.e.env.variables[role1] = result
                                    }
                                } else if (role[0] === '.') {
                                    if (!role1) return
                                    element[role1] = result
                                } else if (role[0] === '@') {
                                    if (!role1) return
                                    element.setAttribute(role1, result)
                                } else if (role[0] === '+') {
                                    this.importPackage(result, role1)
                                } else {
                                    const elementMap = this.e.env.map.get(element) ?? {}
                                    elementMap[role] = result
                                    this.e.env.map.set(element, elementMap)
                                }
                            }
                            for (const t of target) {
                                for (const [role, mm] of applyEntries) {
                                    let result, modPart, args
                                    if (mm.includes('(') && mm.endsWith(')')) {
                                        let [modulePartName, ...argsRest] = mm.split('(')
                                        args = argsRest.join('(').slice(0, -1).split(',').map(s => s.trim())
                                        if (this.#module[modulePartName] === undefined) continue
                                        modPart = this.#module[modulePartName]
                                        if (role[0] !== '!') result = await this.e.utils.getVariableResult(modPart, args, t)
                                    } else if (mm === '$') {
                                        if (this.#module === undefined) continue
                                        result = this.#module
                                    } else {
                                        if (this.#module[mm] === undefined) continue
                                        result = this.#module[mm]
                                    }
                                    if (role.startsWith('!')) {
                                        let [eventName, pipeTo] = role.split('|').map(s => s.trim())
                                        eventName = eventName.slice(1)
                                        if (!eventName) eventName = (t.eDataset || t.hasAttribute('itemscope') || ['input', 'select', 'textarea', 'fieldset', 'form'].includes(t.tagName.toLowerCase())) ? 'change' : 'click'
                                        t.addEventListener(eventName, async event => {
                                            let r = (result === undefined) ? await this.e.utils.getVariableResult(modPart, args, t) : result,
                                                silent = ((eventName === 'change') && (pipeTo === '_')) || ((eventName === 'sinkData') && (pipeTo === '$'))
                                            setResult(r, pipeTo, t, silent)
                                        })
                                    } else { setResult(result, role, t) }
                                }
                            }
                        }
                    }
                },
                _isReference: { configurable: false, enumerable: false, writable: false, value: true },
                _mode: { configurable: false, enumerable: false, writable: false, value: 'plugin' }
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('parser') }

        get map() { return this.#map }
        set map(value) {
            this.#mapMap = this.e.utils.parseObjectAttribute(value, this)
            this.#map = value
        }

        get mapMap() {
            const attrMap = this.getAttribute('map')
            if (attrMap && attrMap !== this.#map) this.map = attrMap
            return this.#mapMap
        }

        get module() { return this.#module }
        set module(value) { this.#module = value }

    }
</script>