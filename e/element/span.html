<style></style>
<template><slot></slot></template>
<script>
    class extends `span` {

        #source
        #query
        #processor
        #errors  
        #jsonata
        #map = 'true,false,,'

        constructor() {
            super()
            Object.defineProperties(this, {
                _mode: {configurable: true, enumerable: false, set: value => this.#mode = value, get: () => this.#mode}
            })
        }

        static get observedAttributes() { return (super.observedAttributes || []).concat('scope', 'source', 'sink', 'processor', 'errors', 'jsonata') }

        async connectedCallback() {
            const scope = this.getRootNode(), sourceElement = (scope instanceof ShadowRoot) ? scope.host : this.parentElement
            if (this.#source) sourceElement = scope.querySelector(this.#source)
            if (!sourceElement || (sourceElement === this)) return            
            sourceElement.addEventListener('change', event => { this.render(sourceElement) })
            await this.render(sourceElement)
        }

        toString() {  }

        async render(sourceElement) {
            if (this.jsonata && !window.jsonata) {
                const scriptTag = document.createElement('script')
                scriptTag.setAttribute('src', 'https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js')
                document.head.append(scriptTag)
            }
            const [t='true', f='false', n='', u=''] = this.#map.split(',')
            let newValue = this.e.getValue(sourceElement)
            if (this.#query) newValue = window.jsonata ? (await window.jsonata(this.#query).evaluate(newValue)) : newValue[this.#query]
            if (newValue === true) newValue = t
            if (newValue === false) newValue = f
            if (newValue === null) newValue = n
            if (newValue === undefined) newValue = u
            if (this.children.length) {
                if (Array.isArray(newValue)) {
                    for (const [i, v] of newValue.entries()) this.e.setValue(this.children[i], v)
                } else if ((newValue instanceof Object) && this.querySelectorAll('[name]').length) {
                    for (const [k, v] of Object.entries(newValue)) this.e.setValue(this.querySelector(`[name="${k}"]`), v)
                } else { this.e.setValue(this.children[0], newValue) }
            } else { this.textContent = newValue }
        }

        set source(value) { this.#source = value }
        get source() { return this.#source }

        set query(value) { this.#query = value }
        get query() { return this.#query }

        set processor(value) { this.#processor = value }
        get processor() { return this.#processor }

        set errors(value) { this.#errors = value }
        get errors() { return this.#errors }

        set jsonata(value) { this.#jsonata = value }
        get jsonata() { return this.#jsonata }

        set map(value) { this.#map = value }
        get map() { return this.#map }

    }
</script>