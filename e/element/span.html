<style></style>
<template><slot></slot></template>
<script>
    class extends `span` {

        #scope
        #source
        #query
        #processor
        #jsonata
        #map = 'true,false,,'

        #sourceElement

        constructor() { super() }

        static get observedAttributes() { return (super.observedAttributes || []).concat('scope', 'source', 'query', 'processor', 'jsonata', 'map') }

        async connectedCallback() {
            let scope = this.#scope ? this.closest(this.#scope) : this.getRootNode()
            scope ||= this.getRootNode()
            let sourceElement = (scope instanceof ShadowRoot) ? scope.host : ( this.#scope ? scope : this.parentElement )
            if (this.#source) sourceElement = sourceElement.querySelector(this.#source)
            if (!sourceElement || (sourceElement === this)) return
            this.#sourceElement = sourceElement
            sourceElement.addEventListener('change', event => { this.render(sourceElement) })
            await this.render(sourceElement)
        }

        toString() { return `${this.#sourceElement}` }

        async render(sourceElement) {
            if (this.jsonata && !window.jsonata) {
                const scriptTag = document.createElement('script')
                scriptTag.setAttribute('src', 'https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js')
                document.head.append(scriptTag)
            }
            const [t='true', f='false', n='', u=''] = this.#map.split(',')
            let newValue = this.e.getValue(sourceElement)
            if (this.#query) newValue = window.jsonata ? (await window.jsonata(this.#query).evaluate(newValue)) : newValue[this.#query]
            if (this.#processor) {
                let processorFunction = this.e.resolveMeta(this, 'e-processor', this.#processor)?.func
                if (processorFunction) useResponse = await processorFunction(newValue)
            }
            if (newValue === true) newValue = t
            if (newValue === false) newValue = f
            if (newValue === null) newValue = n
            if (newValue === undefined) newValue = u
            if (this.children.length) {
                if (Array.isArray(newValue)) {
                    for (const [i, v] of newValue.entries()) this.e.setValue(this.children[i], v)
                } else if ((newValue instanceof Object) && this.querySelectorAll('[name]').length) {
                    for (const [k, v] of Object.entries(newValue)) this.e.setValue(this.querySelector(`[name="${k}"]`), v)
                } else { this.e.setValue(this.children[0], newValue) }
            } else { this.textContent = newValue }
        }

        set scope(value) { this.#scope = value }
        get scope() { return this.#scope }

        set source(value) { this.#source = value }
        get source() { return this.#source }

        set query(value) { this.#query = value }
        get query() { return this.#query }

        set processor(value) { this.#processor = value }
        get processor() { return this.#processor }

        set jsonata(value) { this.#jsonata = value }
        get jsonata() { return this.#jsonata }

        set map(value) { this.#map = value }
        get map() { return this.#map }

    }
</script>